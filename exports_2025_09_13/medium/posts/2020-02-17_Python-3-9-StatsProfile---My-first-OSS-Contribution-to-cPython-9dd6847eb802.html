<!DOCTYPE html><html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Python 3.9 StatsProfile — My first OSS Contribution to cPython</title><style>
      * {
        font-family: Georgia, Cambria, "Times New Roman", Times, serif;
      }
      html, body {
        margin: 0;
        padding: 0;
      }
      h1 {
        font-size: 50px;
        margin-bottom: 17px;
        color: #333;
      }
      h2 {
        font-size: 24px;
        line-height: 1.6;
        margin: 30px 0 0 0;
        margin-bottom: 18px;
        margin-top: 33px;
        color: #333;
      }
      h3 {
        font-size: 30px;
        margin: 10px 0 20px 0;
        color: #333;
      }
      header {
        width: 640px;
        margin: auto;
      }
      section {
        width: 640px;
        margin: auto;
      }
      section p {
        margin-bottom: 27px;
        font-size: 20px;
        line-height: 1.6;
        color: #333;
      }
      section img {
        max-width: 640px;
      }
      footer {
        padding: 0 20px;
        margin: 50px 0;
        text-align: center;
        font-size: 12px;
      }
      .aspectRatioPlaceholder {
        max-width: auto !important;
        max-height: auto !important;
      }
      .aspectRatioPlaceholder-fill {
        padding-bottom: 0 !important;
      }
      header,
      section[data-field=subtitle],
      section[data-field=description] {
        display: none;
      }
      </style></head><body><article class="h-entry">
<header>
<h1 class="p-name">Python 3.9 StatsProfile — My first OSS Contribution to cPython</h1>
</header>
<section data-field="subtitle" class="p-summary">
You can try out all of the code in this article yourself using this Google Colaboratory notebook.
</section>
<section data-field="body" class="e-content">
<section name="2c6a" class="section section--body section--first"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><h3 name="c1cf" id="c1cf" class="graf graf--h3 graf--leading graf--title">Python 3.9 StatsProfile — My first OSS Contribution to cPython</h3><p name="6b3e" id="6b3e" class="graf graf--p graf-after--h3"><em class="markup--em markup--p-em">You can try out all of the code in this article yourself using </em><a href="https://colab.research.google.com/drive/1GBxS6UnJOLyztivEheHBEDOHFFqpRG2y#scrollTo=Vmky1qQQzvVt" data-href="https://colab.research.google.com/drive/1GBxS6UnJOLyztivEheHBEDOHFFqpRG2y#scrollTo=Vmky1qQQzvVt" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank"><em class="markup--em markup--p-em">this Google Colaboratory notebook</em></a><em class="markup--em markup--p-em">.</em></p><p name="9bb4" id="9bb4" class="graf graf--p graf-after--p">If you’ve ever tried to debug and optimize your python application, it’s likely that you stumbled upon <a href="https://docs.python.org/3/library/profile.html#" data-href="https://docs.python.org/3/library/profile.html#" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Python Profiles</a> to understand where most of the execution time is being spent. You enable the profiler at the beginning of a code segment you’re interested in profiling with <code class="markup--code markup--p-code">pr.enable()</code>, and call <code class="markup--code markup--p-code">pr.create_stats()</code>at the end.</p><figure name="afb2" id="afb2" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/9e693eaaca3153a8ff9a2584629388f9.js"></script></figure><p name="1e0f" id="1e0f" class="graf graf--p graf-after--figure">Afterwards, you can create a <a href="https://docs.python.org/3/library/profile.html#the-stats-class" data-href="https://docs.python.org/3/library/profile.html#the-stats-class" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">Stats</a> object, and print the results in a human readable format with <code class="markup--code markup--p-code">ps.print_stats()</code>.</p><figure name="12e2" id="12e2" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*xFXn9qUiognDmqEFkhPlkw.png" data-width="1624" data-height="664" src="https://cdn-images-1.medium.com/max/800/1*xFXn9qUiognDmqEFkhPlkw.png"></figure><p name="6d65" id="6d65" class="graf graf--p graf-after--figure graf--trailing">The output above is quite useful and can take you a long way. However, what if you don’t know what kind of data inputs cause a bottleneck in your application? What if you’re interested in aggregating and evaluating profiling data over some period of time? What if you want to profile your application while your team is dogfooding it? I found that there isn’t an easy way to use this data in an ETL pipeline where you’d be able to do further offline analysis over a larger dataset.</p></div></div></section><section name="4243" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="e643" id="e643" class="graf graf--p graf--leading">I recently made my first <a href="https://github.com/python/cpython/pull/15495" data-href="https://github.com/python/cpython/pull/15495" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">open source cPython contribution</a> which adds a <a href="https://docs.python.org/3/library/dataclasses.html" data-href="https://docs.python.org/3/library/dataclasses.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">dataclass</a> called <code class="markup--code markup--p-code">StatsProfile</code> to address this. After you created your stats object, you can retrieve all the information in the above screenshot by calling <code class="markup--code markup--p-code">ps.get_stats_profile()</code> and analyze it in a programmatic way.</p><p name="cd22" id="cd22" class="graf graf--p graf-after--p">If you’re not on Python3.9 yet, the following code snippet is a slightly modified version of the code in the pull request that you can start using today by importing it directly into your project.</p><figure name="a5fa" id="a5fa" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/31266d61542bbcddb3f57ae684ca0917.js"></script></figure><p name="7347" id="7347" class="graf graf--p graf-after--figure">Now, rather than inspecting the profile of a single execution of our code snippet, we can aggregate and analyze the profiles over several different iterations. In a real production service, depending on which logging tool you use, you would likely need to format and stringify the <code class="markup--code markup--p-code">StatsProfile</code> dataclass before logging it, but for the purposes of this example, everything is stored in memory.</p><p name="dee8" id="dee8" class="graf graf--p graf-after--p">To simulate timestamped logging, <code class="markup--code markup--p-code">(timestamp, stats_profile)</code>tuples are appended to a <code class="markup--code markup--p-code">timestamped_stats_profile </code>list with every execution of the loop.</p><figure name="50b1" id="50b1" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/867a1ec17e3cc470d051c41d62c94896.js"></script></figure><p name="6a3d" id="6a3d" class="graf graf--p graf-after--figure">After the data is logged, it needs to be aggregated over a certain timeslice. Most logging/visualization platforms have their functions to process timeseries data, so this would be platform specific. Sumologic has the <a href="https://help.sumologic.com/05Search/Search-Query-Language/Search-Operators/timeslice" data-href="https://help.sumologic.com/05Search/Search-Query-Language/Search-Operators/timeslice" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">timeslice</a> function, Elasticsearch has examples of how to do <a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-datehistogram-aggregation.html" data-href="https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-datehistogram-aggregation.html" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">date histogram aggregation</a>, Datadog has an <a href="https://www.datadoghq.com/blog/summary-graphs-metric-graphs-101/#distributions" data-href="https://www.datadoghq.com/blog/summary-graphs-metric-graphs-101/#distributions" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">aggregate across time dropdown</a>, etc...</p><p name="8ad2" id="8ad2" class="graf graf--p graf-after--p">For the purposes of this example, I’m doing the aggregation manually in python. I bucket all the logged (i.e. saved) <code class="markup--code markup--p-code">StatsProfile</code> objects over 10 second intervals, aggregate the cumulative execution time, <code class="markup--code markup--p-code">cumtime</code>, per function call and store the resultant counters in <code class="markup--code markup--p-code">time_slices_counters</code>. If you’re interested in inspecting the number of calls to certain functions rather than the cumulative execution time spent in it, you would simply modify the parameter being access on <code class="markup--code markup--p-code">line 21</code> in the code snippet below.</p><figure name="195a" id="195a" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/f34671bf3cb569796acff30bfb4ea178.js"></script></figure><p name="ea9d" id="ea9d" class="graf graf--p graf-after--figure">In my opinion, a stacked bar graph is a great way to visualize and easily interpret this data. Using the following code snippet:</p><figure name="3673" id="3673" class="graf graf--figure graf--iframe graf-after--p"><script src="https://gist.github.com/39d51402401ce69262acafd0b824279e.js"></script></figure><p name="db77" id="db77" class="graf graf--p graf-after--figure">We can generate a graph that looks like this:</p><figure name="8c12" id="8c12" class="graf graf--figure graf-after--p"><img class="graf-image" data-image-id="1*I2-Se8MVV8MlrqoUVtSmxg.png" data-width="2276" data-height="1620" data-is-featured="true" src="https://cdn-images-1.medium.com/max/800/1*I2-Se8MVV8MlrqoUVtSmxg.png"></figure><p name="bc0c" id="bc0c" class="graf graf--p graf-after--figure graf--trailing">The results aren’t very interesting or surprising given the simplicity of a script calling <code class="markup--code markup--p-code">sleep</code>a bunch of times, but hopefully it’ll be more useful in more complex applications.</p></div></div></section><section name="b95a" class="section section--body"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="e2b7" id="e2b7" class="graf graf--p graf--leading graf--trailing">It’s important to note that you probably should not be doing this in production. It could be useful on your local or development environments, and might be worth enabling in a single canary, but could have adverse effects in prod. You would be polluting your logs with large <code class="markup--code markup--p-code">StatsProfile</code> structures, and I have not investigated if running <code class="markup--code markup--p-code">cProfile</code> in prod could potentially downgrade your service’s performance.</p></div></div></section><section name="196f" class="section section--body section--last"><div class="section-divider"><hr class="section-divider"></div><div class="section-content"><div class="section-inner sectionLayout--insetColumn"><p name="007e" id="007e" class="graf graf--p graf--leading">As a side note, though there is some overhead and a small learning curve, I was very pleased with how easy it is to contribute to cPython. Aside from publishing the <a href="https://github.com/python/cpython/pull/15495" data-href="https://github.com/python/cpython/pull/15495" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">actual PR</a>, you have to sign the <a href="https://www.python.org/psf/contrib/contrib-form/" data-href="https://www.python.org/psf/contrib/contrib-form/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">PSF Contributor Agreement</a>, open a on <a href="https://bugs.python.org/issue37958" data-href="https://bugs.python.org/issue37958" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">bugs.python.org</a>, and nudge a few people to make get your code looked at. There is a great <a href="https://devguide.python.org/" data-href="https://devguide.python.org/" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">developer guide</a> on how to run things locally and execute tests. I recently also came by <a href="https://paper.dropbox.com/doc/JlgnduI6kw9MJIaGPpN9G" data-href="https://paper.dropbox.com/doc/JlgnduI6kw9MJIaGPpN9G" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">this doc</a>, which is a good starting point if you’ve never contributed to cPython before.</p><p name="9f9b" id="9f9b" class="graf graf--p graf-after--p graf--trailing">Huge thanks <a href="https://medium.com/u/a5e37e79321" data-href="https://medium.com/u/a5e37e79321" data-anchor-type="2" data-user-id="a5e37e79321" data-action-value="a5e37e79321" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Gregory P. Smith</a> for reviewing and approving my cPython PR! Also, thank you to <a href="https://medium.com/u/5ab59fdac23d" data-href="https://medium.com/u/5ab59fdac23d" data-anchor-type="2" data-user-id="5ab59fdac23d" data-action-value="5ab59fdac23d" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Сергей Яркин</a> for proofreading my article, and a special shoutout to <a href="https://medium.com/u/1d4e9c777efe" data-href="https://medium.com/u/1d4e9c777efe" data-anchor-type="2" data-user-id="1d4e9c777efe" data-action-value="1d4e9c777efe" data-action="show-user-card" data-action-type="hover" class="markup--user markup--p-user" target="_blank">Manuel Dell&#39;Elce</a> who built a really nice <a href="https://chrome.google.com/webstore/detail/code-medium/dganoageikmadjocbmklfgaejpkdigbe/related" data-href="https://chrome.google.com/webstore/detail/code-medium/dganoageikmadjocbmklfgaejpkdigbe/related" class="markup--anchor markup--p-anchor" rel="noopener" target="_blank">chrome extension</a> that made <a href="https://medium.com/@Maluen0/how-to-add-code-highlighting-in-medium-articles-without-leaving-the-editor-8f24f5a88d28" data-href="https://medium.com/@Maluen0/how-to-add-code-highlighting-in-medium-articles-without-leaving-the-editor-8f24f5a88d28" class="markup--anchor markup--p-anchor" target="_blank">embedding code snippets</a> in this medium article a breeze.</p></div></div></section>
</section>
<footer><p>By <a href="https://medium.com/@olshansky" class="p-author h-card">Daniel Olshansky</a> on <a href="https://medium.com/p/9dd6847eb802"><time class="dt-published" datetime="2020-02-17T19:31:48.783Z">February 17, 2020</time></a>.</p><p><a href="https://medium.com/@olshansky/python-3-9-statsprofile-my-first-oss-contribution-to-cpython-9dd6847eb802" class="p-canonical">Canonical link</a></p><p>Exported from <a href="https://medium.com">Medium</a> on September 13, 2025.</p></footer></article></body></html>